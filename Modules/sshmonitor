#!/bin/bash

# Load color utility functions
if [[ -f "/etc/SSHPlus/colors" ]]; then
    source /etc/SSHPlus/colors
elif [[ -f "/bin/colors" ]]; then
    source /bin/colors
elif [[ -f "$(dirname "$0")/colors" ]]; then
    source "$(dirname "$0")/colors"
fi

clear
if [[ -e /usr/lib/licence ]]; then
database="/root/users.db"
tmp_now=$(printf '%(%H%M%S)T\n')
fun_drop () {
port_dropbear=`ps aux | grep dropbear | awk NR==1 | awk '{print $17;}'`
log=/var/log/auth.log
loginsukses='Password auth succeeded'
clear
pids=`ps ax |grep dropbear |grep  " $port_dropbear" |awk -F" " '{print $1}'`
for pid in $pids
do
    pidlogs=`grep $pid $log |grep "$loginsukses" |awk -F" " '{print $3}'`
    i=0
    for pidend in $pidlogs
    do
      let i=i+1
    done
    if [ $pidend ];then
       login=`grep $pid $log |grep "$pidend" |grep "$loginsukses"`
       PID=$pid
       user=`echo $login |awk -F" " '{print $10}' | sed -r "s/'/ /g"`
       waktu=`echo $login |awk -F" " '{print $2"-"$1,$3}'`
       while [ ${#waktu} -lt 13 ]; do
           waktu=$waktu" "
       done
       while [ ${#user} -lt 16 ]; do
           user=$user" "
       done
       while [ ${#PID} -lt 8 ]; do
           PID=$PID" "
       done
       echo "$user $PID $waktu"
    fi
done
}
# Format bytes as human-readable (K/M/G)
_fmt_bytes() {
	awk -v b="${1:-0}" 'BEGIN{
		if(b>=1073741824) printf "%.1fG", b/1073741824
		else if(b>=1048576) printf "%.1fM", b/1048576
		else if(b>=1024) printf "%.0fK", b/1024
		else printf "%dB", b+0
	}'
}

# Per-user I/O (rchar≈download, wchar≈upload) from /proc/<pid>/io
_get_user_traffic() {
	local u="$1" rchar=0 wchar=0
	local pids
	pids=$(ps -u "$u" -o pid= 2>/dev/null) || true
	for pid in $pids; do
		[[ -z "$pid" || ! -r "/proc/$pid/io" ]] && continue
		while read -r k v; do
			case "$k" in rchar:) rchar=$((rchar + v));; wchar:) wchar=$((wchar + v));; esac
		done < "/proc/$pid/io" 2>/dev/null || true
	done
	echo "${rchar}:${wchar}"
}

# Use print_header function for colored header (with Traffic column)
print_header " User         Status       Conn    Time       Down / Up   "
echo ""
echo ""
_userlist=$(awk -F: '$3>=1000 {print $1}' /etc/passwd 2>/dev/null | grep -v nobody)
for user in $_userlist; do
        if [[ -f "$database" ]] && grep -qw "$user" "$database" 2>/dev/null; then
            s2ssh="$(grep -w "$user" "$database" 2>/dev/null | cut -d' ' -f2)"
        else
            s2ssh="1"
        fi
        if [ "$(cat /etc/passwd| grep -w $user| wc -l)" = "1" ]; then
          sqd="$(ps -u $user | grep sshd | wc -l)"
        else
          sqd=00
        fi
        [[ "$sqd" = "" ]] && sqd=0
        if [[ -e /etc/openvpn/openvpn-status.log ]]; then
          ovp="$(cat /etc/openvpn/openvpn-status.log | grep -E ,"$user", | wc -l)"
        else
          ovp=0
        fi
        if netstat -nltp|grep 'dropbear'> /dev/null;then
          drop="$(fun_drop | grep "$user" | wc -l)"
        else
          drop=0
        fi
        cnx=$(($sqd + $drop))
        conex=$(($cnx + $ovp))
        if [[ $cnx -gt 0 ]]; then
          tst="$(ps -o etime $(ps -u $user |grep sshd |awk 'NR==1 {print $1}')|awk 'NR==2 {print $1}')"
          tst1=$(echo "$tst" | wc -c)
        if [[ "$tst1" == "9" ]]; then 
          timerr="$(ps -o etime $(ps -u $user |grep sshd |awk 'NR==1 {print $1}')|awk 'NR==2 {print $1}')"
        else
          timerr="$(echo "00:$tst")"
        fi
        elif [[ $ovp -gt 0 ]]; then
          tmp2=$(printf '%(%H:%M:%S)T\n')
          tmp1="$(grep -w "$user" /etc/openvpn/openvpn-status.log |awk '{print $4}'| head -1)"
          [[ "$tmp1" = "" ]] && tmp1="00:00:00" && tmp2="00:00:00"
          var1=`echo $tmp1 | cut -c 1-2`
          var2=`echo $tmp1 | cut -c 4-5`
          var3=`echo $tmp1 | cut -c 7-8`
          var4=`echo $tmp2 | cut -c 1-2`
          var5=`echo $tmp2 | cut -c 4-5`
          var6=`echo $tmp2 | cut -c 7-8`
          calc1=`echo $var1*3600 + $var2*60 + $var3 | bc`
          calc2=`echo $var4*3600 + $var5*60 + $var6 | bc`
          seg=$(($calc2 - $calc1))
          min=$(($seg/60))
          seg=$(($seg-$min*60))
          hor=$(($min/60))
          min=$(($min-$hor*60))
          timerusr=`printf "%02d:%02d:%02d \n" $hor $min $seg;`
          timerr=$(echo "$timerusr" | sed -e 's/[^0-9:]//ig' )
        else
          timerr="00:00:00"
        fi
        # Per-user traffic (↓=rchar, ↑=wchar from /proc/<pid>/io)
        _io=$(_get_user_traffic "$user")
        _down=$(_fmt_bytes "${_io%%:*}")
        _up=$(_fmt_bytes "${_io##*:}")
        traffic_str="↓$_down / ↑$_up"

        # Use color codes for status display (printf %b so escapes are interpreted)
        yellow_code=$(get_color_code "yellow")
        red_code=$(get_color_code "red")
        green_code=$(get_color_code "green")
        blue_code=$(get_color_code "blue")
        reset_code=$(get_reset_code)

        if [[ $conex -eq 0 ]]; then
           status="${red_code}Offline ${yellow_code}       "
        else
           status="${green_code}Online${yellow_code}         "
        fi
        printf '%b%-17s%b%-8s%-10s%-14s%b\n' "$yellow_code" " $user" "$status" "$conex/$s2ssh" "$timerr" "$traffic_str" "$reset_code"
        echo -e "${blue_code}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${reset_code}"
done
    echo ""
    color_echo_n "Press Enter to return to menu" "yellow"
    read -r
fi
#exit
